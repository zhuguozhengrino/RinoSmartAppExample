# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

# è§£å†³ fastlane æ— æ³•è·å–list price bug
require 'spaceship'
Spaceship::ConnectAPI::App.const_set('ESSENTIAL_INCLUDES', 'appStoreVersions')

default_platform(:ios)


platform :ios do

  desc 'æ„å»ºå‰çš„å‡†å¤‡å·¥ä½œ'
  desc 'è¿™æ˜¯ä¸€ä¸ªç§æœ‰ä»»åŠ¡ï¼Œä»…ä¾› Fastfile å†…éƒ¨ lane è°ƒç”¨ä½¿ç”¨'
  lane :prepare do
    cocoapods(
      clean: true,
      podfile: "Podfile"
    )
  end
      
  desc "è·å– apple connect api key"
  desc 'è¿™æ˜¯ä¸€ä¸ªç§æœ‰ä»»åŠ¡ï¼Œä»…ä¾› Fastfile å†…éƒ¨ lane è°ƒç”¨ä½¿ç”¨'
  lane :get_api_key do
    # è·å–è®¿é—® App Store Connect API çš„ key
    api_key = app_store_connect_api_key(
    key_id: ENV["key_id"],
    issuer_id: ENV["issuer_id"],
    key_filepath: ENV["key_filepath"],
    duration: 500,  # App Store Connect ä¼šè¯æ—¶é•¿çš„ä¸Šé™
    in_house: false # ä¼ä¸šçº§å¼€å‘è€…
  )
  end

  desc "ç¼–è¯‘ IOS åŒ…"
  lane :build do |options|
    prepare
    
    #è·å–æœ€åä¸€æ¬¡gitæäº¤ 
    commit = last_git_commit

    # æ„å»ºç‰ˆæœ¬ Debug/Release ......
    config_type = options[:config_type] || "Debug"

    api_key = get_api_key

    # è·å– app åœ¨ TestFlight ä¸Šçš„æœ€æ–° build å€¼
    # previous_build_number = latest_testflight_build_number(
    #   app_identifier: ENV["app_identifier"],
    #   api_key: api_key
    # )
    # current_build_number = increment_build_number

    # æŠŠ app çš„ build å€¼è®¾ä¸º current_build_number
    # increment_build_number(
    #   xcodeproj: ENV["Rino.xcodeproj"],
    #   build_number: current_build_number
    # )
    # current_build_number = previous_build_number + 1
    # current_build_number = increment_build_number
    current_build_number = get_build_number(xcodeproj: "Rino.xcodeproj")

    export_method = options[:export_method] || 'ad-hoc'
    gym(
      configuration: config_type,
      export_method: export_method,
      export_xcargs: '-allowProvisioningUpdates',
      output_directory: ENV["output_dir"],
      output_name: ENV["output_name"],
    )
    case options[:upload_to]
    when 'testflight'
      puts "*************| å¼€å§‹ä¸Šä¼ åˆ° Testflight... |*************"
      pilot(
        ipa: ENV["output_dir"] + '/' + ENV["output_name"],
        skip_submission: true,
        skip_waiting_for_build_processing: true,
        build_number: current_build_number
      )
      puts "*************| ä¸Šä¼ åˆ° Testflight æˆåŠŸğŸ‰ |*************"
      notify_wechat_bot(message: "Rino IOS ç‰ˆæœ¬å·²ä¸Šä¼  Testflight - #{git_branch} åˆ†æ”¯, #{config_type} ç‰ˆæœ¬(Debugç‰ˆæœ¬å¯ä»¥ä½¿ç”¨æ‘‡ä¸€æ‘‡)")
    when 'applestore'
      puts "*************| å¼€å§‹ä¸Šä¼ åˆ° Apple Connect... |*************"
      deliver(
        build_number: current_build_number,
        submit_for_review: true,
        skip_screenshots: true, # è·³è¿‡ä¸Šä¼ æˆªå›¾
        force: true, # ä¸Šä¼ ä¹‹å‰ä¸ç”ŸæˆhtmlæŠ¥å‘Š
        overwrite_screenshots: false, # æ˜¯å¦è¦†ç›–ITCä¸Šå·²æœ‰çš„æˆªå›¾
        api_key: api_key,
        run_precheck_before_submit: false
      )
      puts "*************| ä¸Šä¼ åˆ° Apple Connect æˆåŠŸğŸ‰ |*************"
      notify_wechat_bot(message: "Rino IOS ç‰ˆæœ¬å·²ä¸Šä¼  Apple è¿›è¡Œå®¡æ ¸ï¼ï¼ï¼  - #{git_branch} åˆ†æ”¯, #{config_type} ç‰ˆæœ¬(Debugç‰ˆæœ¬å¯ä»¥ä½¿ç”¨æ‘‡ä¸€æ‘‡)")
    else 
      commit_info = commit[:message] + "ä½œè€…ï¼š"+ commit[:author]
      # ä¸Šä¼  fir
      puts "*************| å¼€å§‹ä¸Šä¼ åˆ° Fir... |*************"
      fir_cli(
        api_token: ENV["api_token"],
        specify_file_path: ENV["output_dir"] + '/' + ENV["output_name"],
        wxwork_access_token: ENV["wxwork_access_token"],
        changelog: "#{commit_info}",
        specify_icon_file: ENV["app_logo"],
        need_release_id: true,
        force_pin_history: true,
        wxwork_pic_url: "https://rinoiot.com/img/aboutUs_1_1.png",
        wxwork_custom_message: "æ›´æ–°å†…å®¹: \n#{commit_info}\n ç‚¹å‡»å¡ç‰‡ä¸‹è½½ APP â†‘â†‘â†‘â†‘â†‘â†‘  - #{git_branch} åˆ†æ”¯, #{config_type} ç‰ˆæœ¬(Debugç‰ˆæœ¬å¯ä»¥ä½¿ç”¨æ‘‡ä¸€æ‘‡)"
      )
      puts "*************| ä¸Šä¼ åˆ° Fir æˆåŠŸğŸ‰ |*************"
      # notify_wechat_bot(message: "Rino IOS ç‰ˆæœ¬å·²ä¸Šä¼  Fir, è®¿é—®ä¸Šæ–¹é“¾æ¥ä¸‹è½½ APP â†‘â†‘â†‘â†‘â†‘â†‘  - #{git_branch} åˆ†æ”¯, #{config_type} ç‰ˆæœ¬(Debugç‰ˆæœ¬å¯ä»¥ä½¿ç”¨æ‘‡ä¸€æ‘‡)")
    end
    clean
  end

  desc "æ¸…é™¤å·²ç»æ„å»ºçš„IPAç­‰æ–‡ä»¶"
  lane :clean do
    clean_build_artifacts
  end

  desc "é€šçŸ¥ä¼ä¸šå¾®ä¿¡"
  lane :notify_wechat_bot do |options|
    message = options[:message]
    # å®šä¹‰å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥çš„ Lane
      # ä½¿ç”¨ sh action æ‰§è¡Œ curl å‘½ä»¤
    command = "curl -H 'Content-Type: application/json' -X POST " \
      "-d '{\"msgtype\": \"text\", \"text\": {\"content\": \"#{message}\"}}' " \
      "'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=#{ENV["wxwork_access_token"]}'"
    sh(command)
  end

  desc "æ‰“åŒ…å¤±è´¥é€šçŸ¥"
  error do |lane, exception|
    # è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„ lane åç§°
    current_lane = lane_context[Fastlane::Actions::SharedValues::LANE_NAME]
  
    # æ‰“åŒ…å¤±è´¥ï¼Œå‘é€é€šçŸ¥åˆ°ä¼ä¸šå¾®ä¿¡
    notify_wechat_bot(message: "#{current_lane} æ‰“åŒ…å¤±è´¥") 
  
    # æ¸…ç†æ„å»ºæ–‡ä»¶
    clean_build_artifacts
  end

  desc "æµ‹è¯•ç‰ˆæœ¬å·"
  lane :get_current_version do |options|
    current_build_number = get_build_number(xcodeproj: "Rino.xcodeproj")
    puts "å½“å‰æœ¬åœ°ç‰ˆæœ¬ï¼š#{current_build_number}"
  end

end